"use strict";(self.webpackChunkpmdm=self.webpackChunkpmdm||[]).push([[3130],{28453:(e,n,i)=>{i.d(n,{R:()=>s,x:()=>r});var a=i(96540);const o={},l=a.createContext(o);function s(e){const n=a.useContext(l);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function r(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(o):e.components||o:s(e.components),a.createElement(l.Provider,{value:n},e.children)}},42379:(e,n,i)=>{i.d(n,{A:()=>a});const a=i.p+"assets/images/id-cliente-web-b83a990a22130a7d08dd98a2b15c593a.png"},45977:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>t,contentTitle:()=>r,default:()=>g,frontMatter:()=>s,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"pmdm_2526/ut5_persistencia/firebase/authentication/demo-gmail","title":"Demo - Autenticaci\xf3n con Google (Gmail)","description":"Tutorial guiado para implementar login con Google usando Firebase Authentication en Android (Java), manteniendo MVVM + Repository y reutilizando la MainActivity del demo anterior.","source":"@site/docs/01_pmdm_2526/ut5_persistencia/4-firebase/1-authentication/2-demo-gmail.md","sourceDirName":"01_pmdm_2526/ut5_persistencia/4-firebase/1-authentication","slug":"/pmdm_2526/ut5_persistencia/firebase/authentication/demo-gmail","permalink":"/DevTacora/docs/pmdm_2526/ut5_persistencia/firebase/authentication/demo-gmail","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"title":"Demo - Autenticaci\xf3n con Google (Gmail)","sidebar_position":2,"description":"Tutorial guiado para implementar login con Google usando Firebase Authentication en Android (Java), manteniendo MVVM + Repository y reutilizando la MainActivity del demo anterior.","keywords":["Firebase Authentication","Google Sign-In","Gmail","Android","Java","Login","MVVM","Repository","AndroidViewModel"]},"sidebar":"pmdm_2526_Sidebar","previous":{"title":"Demo - Autenticaci\xf3n con email y contrase\xf1a","permalink":"/DevTacora/docs/pmdm_2526/ut5_persistencia/firebase/authentication/demo-mail-pass"},"next":{"title":"Firestore Database","permalink":"/DevTacora/docs/pmdm_2526/ut5_persistencia/firebase/firestore/"}}');var o=i(74848),l=i(28453);const s={title:"Demo - Autenticaci\xf3n con Google (Gmail)",sidebar_position:2,description:"Tutorial guiado para implementar login con Google usando Firebase Authentication en Android (Java), manteniendo MVVM + Repository y reutilizando la MainActivity del demo anterior.",keywords:["Firebase Authentication","Google Sign-In","Gmail","Android","Java","Login","MVVM","Repository","AndroidViewModel"]},r=void 0,t={},c=[{value:"Paso 1. Habilitar Google Sign-In en Firebase",id:"paso-1-habilitar-google-sign-in-en-firebase",level:2},{value:"Paso 2. Huella digital SHA-1",id:"paso-2-huella-digital-sha-1",level:2},{value:"2.1. Obtener la huella SHA-1",id:"21-obtener-la-huella-sha-1",level:3},{value:"2.2. Agregar SHA-1 en Firebase",id:"22-agregar-sha-1-en-firebase",level:3},{value:"Paso 3. Agregar Dependencias en build.gradle",id:"paso-3-agregar-dependencias-en-buildgradle",level:2},{value:"Paso 4. Agregar el Bot\xf3n de Google en LoginActivity",id:"paso-4-agregar-el-bot\xf3n-de-google-en-loginactivity",level:2},{value:"Paso 5. Implementar la l\xf3gica",id:"paso-5-implementar-la-l\xf3gica",level:2},{value:"5.1. A\xf1adir el login con Google en el Repository",id:"51-a\xf1adir-el-login-con-google-en-el-repository",level:3},{value:"5.2. A\xf1adir el login con Google en el ViewModel",id:"52-a\xf1adir-el-login-con-google-en-el-viewmodel",level:3},{value:"5.3. Obtener el Web Client Id",id:"53-obtener-el-web-client-id",level:3},{value:"5.4. Gestionar el login con Google en <code>LoginActivity</code>",id:"54-gestionar-el-login-con-google-en-loginactivity",level:3},{value:"Paso 6. Gestionar el cierre de sesi\xf3n en <code>MainActivity.java</code>",id:"paso-6-gestionar-el-cierre-de-sesi\xf3n-en-mainactivityjava",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",hr:"hr",img:"img",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,o.jsxs)("div",{class:"justify-text",children:[(0,o.jsxs)(n.p,{children:["Vamos a ",(0,o.jsx)(n.strong,{children:"agregar la autenticaci\xf3n con Google"})," en nuestro proyecto anterior, donde implementamos login con email/contrase\xf1a."]}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"UT5. GIF resumen de la aplicaci\xf3n",src:i(51423).A+"",width:"420",height:"898"})}),(0,o.jsx)(n.p,{children:"Antes de empezar, entendamos las tecnolog\xedas que usaremos:"}),(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Firebase Authentication"}),":  es un servicio que nos permite autenticar usuarios de forma segura sin necesidad de gestionar un backend propio."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"OAuth 2.0"}),": Google utiliza ",(0,o.jsx)(n.strong,{children:"OAuth 2.0"})," para autenticar a los usuarios. Es un protocolo seguro que permite a las apps acceder a la informaci\xf3n de Google del usuario sin exponer sus credenciales."]}),"\n"]}),"\n"]}),(0,o.jsxs)(n.p,{children:["No obstante, ",(0,o.jsx)(n.strong,{children:"Firebase simplifica el proceso"}),", por lo que ",(0,o.jsx)(n.strong,{children:"no necesitas manejar tokens de OAuth manualmente"}),". Solo necesitas configurar Firebase y usar su SDK."]}),(0,o.jsx)(n.p,{children:"El uso de estas dos tecnolog\xedas independientes supone que el login con Google en Firebase tenga dos pasos fundamentales:"}),(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Obtener el usuario de Google"}),": Se inicia el flujo de Google Sign-In para que el usuario seleccione su cuenta y se obtenga su informaci\xf3n (correo, ID Token, etc.)."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Autenticar el usuario en Firebase Auth"}),": Se usa el ID Token obtenido para crear una credencial (",(0,o.jsx)(n.code,{children:"AuthCredential"}),"), que luego se env\xeda a Firebase para autenticar al usuario dentro de la app."]}),"\n"]}),"\n"]}),(0,o.jsx)(n.hr,{}),(0,o.jsx)(n.h2,{id:"paso-1-habilitar-google-sign-in-en-firebase",children:"Paso 1. Habilitar Google Sign-In en Firebase"}),(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["Ve a la ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.a,{href:"https://console.firebase.google.com/",children:"Firebase Console"})}),"."]}),"\n",(0,o.jsxs)(n.li,{children:["Entra en tu proyecto y ve a ",(0,o.jsx)(n.strong,{children:"Authentication"})," > ",(0,o.jsx)(n.strong,{children:"M\xe9todo de acceso"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:["Pulsa sobre el bot\xf3n ",(0,o.jsx)(n.strong,{children:"Agregar proveedor nuevo"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:["Habilita ",(0,o.jsx)(n.strong,{children:"Google"})," y ",(0,o.jsx)(n.strong,{children:"guarda los cambios"}),"."]}),"\n"]}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Habilitar Google Sign-In",src:i(68281).A+"",width:"1932",height:"658"})}),(0,o.jsxs)(n.ol,{start:"5",children:["\n",(0,o.jsx)(n.li,{children:"Introduce el nombre de tu aplicaci\xf3n (ser\xe1 el que se muestre en el correo que les llega a los usuarios despu\xe9s de acceder por primera vez) y el correo de asistencia al proyecto."}),"\n"]}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Configuraci\xf3n del proveedor",src:i(67920).A+"",width:"1938",height:"1440"})}),(0,o.jsx)(n.hr,{}),(0,o.jsx)(n.h2,{id:"paso-2-huella-digital-sha-1",children:"Paso 2. Huella digital SHA-1"}),(0,o.jsxs)(n.p,{children:["Cuando activas ",(0,o.jsx)(n.strong,{children:"autenticaci\xf3n con Google en Firebase"}),", Firebase necesita ",(0,o.jsx)(n.strong,{children:"verificar"})," que tu aplicaci\xf3n est\xe1 realmente conectada a tu proyecto de Firebase y a Google Cloud."]}),(0,o.jsxs)(n.p,{children:["Para ello, requiere ",(0,o.jsx)(n.strong,{children:"una huella digital SHA-1"}),", que es un identificador \xfanico generado a partir de la clave de firma de la app."]}),(0,o.jsxs)(n.p,{children:["Esto es necesario porque ",(0,o.jsx)(n.strong,{children:"Google Sign-In usa OAuth 2.0"}),", y para que Firebase pueda autenticar a los usuarios con sus cuentas de Google, necesita asociar la app con un ",(0,o.jsx)(n.strong,{children:"SHA-1 v\xe1lido"}),"."]}),(0,o.jsx)(n.p,{children:"Hay dos tipos de claves SHA-1 que puedes agregar:"}),(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"SHA-1 de desarrollo"})," (para pruebas en Android Studio)."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.strong,{children:"SHA-1 de producci\xf3n"})," (para versiones firmadas y subidas a Google Play)."]}),"\n"]}),(0,o.jsx)(n.p,{children:"A continuaci\xf3n se explica c\xf3mo obtener SHA-1 de Desarrollo (Modo Debug):"}),(0,o.jsx)(n.h3,{id:"21-obtener-la-huella-sha-1",children:"2.1. Obtener la huella SHA-1"}),(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Abre Android Studio"})," y ve a la ",(0,o.jsx)(n.strong,{children:"terminal"})," (",(0,o.jsx)(n.code,{children:"View > Tool Windows > Terminal"}),")."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Escribe el siguiente comando y presiona ",(0,o.jsx)(n.code,{children:"Enter"}),":"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"./gradlew signingReport\n"})}),"\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"En Windows"}),", usa:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-sh",children:"gradlew signingReport\n"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsx)(n.p,{children:"Espera unos segundos y ver\xe1s una salida como esta:"}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{children:"Variant: debug\nConfig: debug\nStore: /Users/tuusuario/.android/debug.keystore\nAlias: AndroidDebugKey\nMD5:  A1:B2:C3:D4:E5:F6:G7:H8:I9:J0\nSHA1: 11:22:33:44:55:66:77:88:99:AA:BB:CC:DD:EE:FF:GG:HH:II:JJ\nSHA-256: XX:YY:ZZ...\n"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Copia el SHA-1"})," (solo los n\xfameros despu\xe9s de ",(0,o.jsx)(n.code,{children:"SHA1:"}),")."]}),"\n"]}),"\n"]}),(0,o.jsx)(n.h3,{id:"22-agregar-sha-1-en-firebase",children:"2.2. Agregar SHA-1 en Firebase"}),(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsxs)(n.strong,{children:["Ve a la ",(0,o.jsx)(n.a,{href:"https://console.firebase.google.com/",children:"Firebase Console"})]}),"."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["En tu proyecto, haz clic en \u2699 ",(0,o.jsx)(n.strong,{children:"General"}),"."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Configuraci\xf3n del proyecto",src:i(99593).A+"",width:"954",height:"382"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["En la secci\xf3n ",(0,o.jsx)(n.strong,{children:"Tus apps"}),", selecciona tu app de Android. (Pesta\xf1a ",(0,o.jsx)(n.strong,{children:"General"}),", abajo del todo)"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:'En la parte de "Huellas digitales del certificado SHA"'}),", selecciona ",(0,o.jsx)(n.code,{children:"Agregar huella digital"}),"."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"Huella digital",src:i(69276).A+"",width:"1890",height:"1432"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Guarda los cambios y vuelve a descargar y a\xf1adir a tu proyecto el archivo ",(0,o.jsx)(n.strong,{children:"google-services.json"}),"."]}),"\n"]}),"\n"]}),(0,o.jsx)(n.hr,{}),(0,o.jsx)(n.h2,{id:"paso-3-agregar-dependencias-en-buildgradle",children:"Paso 3. Agregar Dependencias en build.gradle"}),(0,o.jsxs)(n.p,{children:["Abre ",(0,o.jsx)(n.code,{children:"build.gradle (Module: app)"})," y ",(0,o.jsx)(n.strong,{children:"a\xf1ade estas dependencias"})," (si has implementado el ejercicio anterior, ya debes tener las dos primera dependencias):"]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-gradle",children:'dependencies {\n    // Firebase BoM\n    implementation(platform("com.google.firebase:firebase-bom:34.8.0"))\n    // Firebase Auth\n    implementation("com.google.firebase:firebase-auth")\n\n    // Google Sign-In (Play Services Auth)\n    implementation("com.google.android.gms:play-services-auth:21.5.0")\n}\n'})}),(0,o.jsxs)(n.p,{children:["Luego, ",(0,o.jsx)(n.strong,{children:"sincroniza el proyecto"})," (",(0,o.jsx)(n.code,{children:"Sync Now"}),")."]}),(0,o.jsx)(n.hr,{}),(0,o.jsx)(n.h2,{id:"paso-4-agregar-el-bot\xf3n-de-google-en-loginactivity",children:"Paso 4. Agregar el Bot\xf3n de Google en LoginActivity"}),(0,o.jsxs)(n.p,{children:["En ",(0,o.jsx)(n.code,{children:"activity_login.xml"}),", ",(0,o.jsx)(n.strong,{children:"agrega un bot\xf3n para iniciar sesi\xf3n con Google"}),":"]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-xml",children:'<com.google.android.gms.common.SignInButton\n    android:id="@+id/googleSignInButton"\n    android:layout_width="wrap_content"\n    android:layout_height="wrap_content"\n    android:layout_marginTop="30dp"/>\n'})}),(0,o.jsxs)(n.p,{children:["\ud83d\udccc ",(0,o.jsx)(n.strong,{children:"Este bot\xf3n es el oficial de Google Sign-In"})," y se ver\xe1 como el bot\xf3n t\xedpico de ",(0,o.jsx)(n.strong,{children:'"Iniciar sesi\xf3n con Google"'}),"."]}),(0,o.jsx)(n.hr,{}),(0,o.jsx)(n.h2,{id:"paso-5-implementar-la-l\xf3gica",children:"Paso 5. Implementar la l\xf3gica"}),(0,o.jsx)(n.h3,{id:"51-a\xf1adir-el-login-con-google-en-el-repository",children:"5.1. A\xf1adir el login con Google en el Repository"}),(0,o.jsxs)(n.p,{children:["En el caso del login con Google, ",(0,o.jsx)(n.strong,{children:"la app no env\xeda directamente un email y una contrase\xf1a a Firebase"}),".\nEn su lugar, Google se encarga de autenticar al usuario y devuelve un ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"idToken"})}),"."]}),(0,o.jsxs)(n.p,{children:["El ",(0,o.jsx)(n.strong,{children:(0,o.jsx)(n.code,{children:"idToken"})})," es un token seguro que:"]}),(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Identifica al usuario autenticado en Google"}),"\n",(0,o.jsx)(n.li,{children:"Garantiza que la autenticaci\xf3n ha sido realizada por Google"}),"\n",(0,o.jsx)(n.li,{children:"Puede ser verificado posteriormente por Firebase"}),"\n"]}),(0,o.jsxs)(n.p,{children:["A partir de este ",(0,o.jsx)(n.code,{children:"idToken"}),", Firebase crea una ",(0,o.jsxs)(n.strong,{children:["credencial (",(0,o.jsx)(n.code,{children:"AuthCredential"}),")"]}),", que es el objeto que representa la identidad del usuario y permite a Firebase confiar en el proveedor externo (Google)."]}),(0,o.jsxs)(n.p,{children:["El ",(0,o.jsx)(n.code,{children:"Repository"})," se encarga de transformar ese token en una credencial v\xe1lida y realizar la autenticaci\xf3n en Firebase."]}),(0,o.jsx)(n.p,{children:"A\xf1ade el siguiente m\xe9todo:"}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",metastring:'title="AuthRepository.java"',children:"// Inicia sesi\xf3n utilizando una cuenta de Google.\n// Recibe el idToken proporcionado por Google tras la autenticaci\xf3n\n// y notifica el resultado mediante AuthCallback.\npublic void loginWithGoogle(String idToken, AuthCallback callback) {\n\n    // Se crea una credencial de Firebase a partir del idToken de Google.\n    // Esta credencial permite a Firebase verificar la identidad del usuario.\n    AuthCredential credential = GoogleAuthProvider.getCredential(idToken, null);\n\n    // Autenticaci\xf3n as\xedncrona en Firebase usando la credencial de Google.\n    auth.signInWithCredential(credential)\n            // Si la autenticaci\xf3n es correcta, devolvemos el usuario actual.\n            .addOnSuccessListener(result -> callback.onSuccess(auth.getCurrentUser()))\n            // Si ocurre un error, se mapea la excepci\xf3n a un mensaje comprensible.\n            .addOnFailureListener(e -> callback.onError(mapError(e)));\n}\n"})}),(0,o.jsx)(n.hr,{}),(0,o.jsx)(n.h3,{id:"52-a\xf1adir-el-login-con-google-en-el-viewmodel",children:"5.2. A\xf1adir el login con Google en el ViewModel"}),(0,o.jsxs)(n.p,{children:["El ViewModel act\xfaa como intermediario entre la interfaz de usuario y el Repository.\nSe encarga de validar los datos recibidos desde la UI, iniciar el proceso de autenticaci\xf3n y actualizar el estado observable (",(0,o.jsx)(n.code,{children:"AuthState"}),") para que la interfaz reaccione a los cambios (cargando, error o \xe9xito)."]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",metastring:'title="AuthViewModel.java"',children:'// Inicia el proceso de login con Google a partir del idToken obtenido en la UI.\npublic void loginWithGoogle(String idToken) {\n\n    // Validaci\xf3n inicial: si no hay token, no se puede continuar con el login.\n    if (idToken == null || idToken.trim().isEmpty()) {\n        authState.setValue(AuthState.error("No se pudo obtener el token de Google."));\n        return;\n    }\n\n    // Indicamos que comienza la operaci\xf3n de autenticaci\xf3n.\n    authState.setValue(AuthState.loading());\n\n    // Delegamos el login en el Repository.\n    repo.loginWithGoogle(idToken, new AuthRepository.AuthCallback() {\n\n        @Override\n        public void onSuccess(FirebaseUser user) {\n            // Si el login es correcto, publicamos el estado de \xe9xito.\n            authState.postValue(AuthState.success(user));\n        }\n\n        @Override\n        public void onError(String message) {\n            // Si ocurre un error, publicamos el estado de error.\n            authState.postValue(AuthState.error(message));\n        }\n    });\n}\n'})}),(0,o.jsx)(n.hr,{}),(0,o.jsx)(n.h3,{id:"53-obtener-el-web-client-id",children:"5.3. Obtener el Web Client Id"}),(0,o.jsxs)(n.p,{children:["El ",(0,o.jsx)(n.strong,{children:"Web Client ID"})," (o ",(0,o.jsx)(n.strong,{children:"Client ID de OAuth 2.0"}),") es un identificador \xfanico generado por ",(0,o.jsx)(n.strong,{children:"Google Cloud Platform (GCP)"})," que permite a tu aplicaci\xf3n comunicarse con los servidores de Google para autenticar a los usuarios mediante ",(0,o.jsx)(n.strong,{children:"Google Sign-In"}),"."]}),(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Es necesario para que Firebase pueda validar la identidad de los usuarios que inician sesi\xf3n con Google."}),"\n",(0,o.jsx)(n.li,{children:'Se usa en Android para obtener un "ID Token" que luego se intercambia con Firebase para autenticar al usuario.'}),"\n",(0,o.jsx)(n.li,{children:"Cada proyecto de Firebase tiene su propio Web Client ID, y debe configurarse correctamente para que Google Sign-In funcione en tu app."}),"\n"]}),(0,o.jsx)(n.p,{children:"Para obtener el Web Client ID en Firebase sigue estos pasos:"}),(0,o.jsxs)(n.ol,{children:["\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Abre Firebase Console"}),": ",(0,o.jsx)(n.a,{href:"https://console.firebase.google.com/",children:"https://console.firebase.google.com/"})]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:[(0,o.jsx)(n.strong,{children:"Selecciona tu proyecto"}),"."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["En el men\xfa lateral, ve a ",(0,o.jsx)(n.strong,{children:'"Authentication"'})," (\u2699)."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Dir\xedgete a la pesta\xf1a ",(0,o.jsx)(n.strong,{children:'"M\xe9todos de acceso"'}),"."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Selecciona el proveedor ",(0,o.jsx)(n.strong,{children:"Google"})," que hemos configurado previamente."]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Despliega el apartado ",(0,o.jsx)(n.strong,{children:"Configuraci\xf3n del SDK web"})," y copia el primer campo."]}),"\n",(0,o.jsx)(n.p,{children:(0,o.jsx)(n.img,{alt:"ID cliente web",src:i(42379).A+"",width:"1930",height:"1208"})}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["\n",(0,o.jsxs)(n.p,{children:["Agr\xe9galo a ",(0,o.jsx)(n.code,{children:"res/values/strings.xml"})," para mayor organizaci\xf3n:"]}),"\n",(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-xml",children:'<string name="default_web_client_id">1234567890-abcdefghij.apps.googleusercontent.com</string>\n'})}),"\n"]}),"\n"]}),(0,o.jsx)(n.hr,{}),(0,o.jsxs)(n.h3,{id:"54-gestionar-el-login-con-google-en-loginactivity",children:["5.4. Gestionar el login con Google en ",(0,o.jsx)(n.code,{children:"LoginActivity"})]}),(0,o.jsxs)(n.p,{children:["En este apartado se ampl\xeda la ",(0,o.jsx)(n.code,{children:"LoginActivity"})," del demo anterior para a\xf1adir el inicio de sesi\xf3n con Google.\nLa l\xf3gica de email y contrase\xf1a se mantiene sin cambios y se incorporan \xfanicamente los elementos necesarios para lanzar el selector de Google, obtener el ",(0,o.jsx)(n.code,{children:"idToken"})," y delegar la autenticaci\xf3n en el ",(0,o.jsx)(n.code,{children:"ViewModel"}),"."]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",metastring:'title="LoginActivity.java"',children:'public class LoginActivity extends AppCompatActivity {\n\n    private AuthViewModel viewModel;\n    private ActivityLoginBinding binding;\n    //highlight-next-line\n    private GoogleSignInClient googleClient;\n\n    // Launcher moderno para recibir el resultado del Intent de Google\n    //highlight-next-line\n    private ActivityResultLauncher<Intent> googleLauncher;\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView((binding = ActivityLoginBinding.inflate(getLayoutInflater())).getRoot());\n\n        viewModel = new ViewModelProvider(this).get(AuthViewModel.class);\n\n        // Si ya hay usuario autenticado, saltamos directamente a la pantalla principal\n        if (viewModel.getCurrentUser() != null) {\n            goToMain();\n            return;\n        }\n\n        // Inicializaci\xf3n de componentes comunes (igual que en el demo anterior)\n        observeAuthState();\n        inicializarBotones();\n\n        // Inicializaci\xf3n espec\xedfica del login con Google\n        //highlight-next-line\n        configurarGoogleSignIn();\n        //highlight-next-line\n        inicializarLauncherGoogleSignIn();\n    }\n\n    // Configura las opciones de Google Sign-In necesarias para Firebase\n    //highlight-start\n    private void configurarGoogleSignIn() {\n        GoogleSignInOptions gso = new GoogleSignInOptions.Builder(GoogleSignInOptions.DEFAULT_SIGN_IN)\n                .requestEmail()\n                // Token necesario para autenticar posteriormente en Firebase\n                .requestIdToken(getString(R.string.default_web_client_id))\n                .build();\n\n        googleClient = GoogleSignIn.getClient(this, gso);\n    }\n    //highlight-end\n    \n\n    // Inicializa el launcher que recibir\xe1 el resultado del selector de Google\n    //highlight-start\n    private void inicializarLauncherGoogleSignIn() {\n        googleLauncher = registerForActivityResult(\n                new ActivityResultContracts.StartActivityForResult(),\n                result -> {\n\n                    if (result.getResultCode() != Activity.RESULT_OK || result.getData() == null) {\n                        // Usuario cancel\xf3 el login o no se recibieron datos\n                        Toast.makeText(this, "Login con Google cancelado.", Toast.LENGTH_SHORT).show();\n                        return;\n                    }\n\n                    Task<GoogleSignInAccount> task =\n                            GoogleSignIn.getSignedInAccountFromIntent(result.getData());\n\n                    gestionarResultadoSignIn(task);\n                }\n        );\n    }\n    //highlight-end\n\n    // Procesa el resultado del login con Google\n    //highlight-start\n    private void gestionarResultadoSignIn(Task<GoogleSignInAccount> task) {\n        try {\n            GoogleSignInAccount account = task.getResult(ApiException.class);\n\n            if (account == null || account.getIdToken() == null) {\n                Toast.makeText(this, "No se pudo obtener la cuenta de Google.", Toast.LENGTH_LONG).show();\n                return;\n            }\n\n            // Enviamos el idToken al ViewModel para autenticar en Firebase\n            viewModel.loginWithGoogle(account.getIdToken());\n\n        } catch (ApiException e) {\n            Toast.makeText(this, "Error Google Sign-In: " + e.getMessage(), Toast.LENGTH_LONG).show();\n        }\n    }\n    //highlight-end\n\n    private void observeAuthState() {\n        viewModel.getAuthState().observe(this, state -> {\n            if (state == null) return;\n\n            // Deshabilita botones y muestra la progress bar si la petici\xf3n est\xe1 en proceso\n            habilitarInterfaz(state.loading);\n\n            // Si hay un error, mostramos el mensaje\n            if (state.error != null) {\n                Toast.makeText(this, state.error, Toast.LENGTH_LONG).show();\n                return;\n            }\n\n            // Si todo va bien, pasamos a la pantalla principal\n            if (state.user != null) {\n                goToMain();\n            }\n        });\n    }\n\n    private void habilitarInterfaz(boolean cargando) {\n        if (cargando) {\n            binding.registerButton.setEnabled(false);\n            binding.loginButton.setEnabled(false);\n            //highlight-next-line\n            binding.googleSignInButton.setEnabled(false);\n            binding.emailEditText.setEnabled(false);\n            binding.passwordEditText.setEnabled(false);\n            binding.progressBar.setVisibility(View.VISIBLE);\n        } else {\n            binding.registerButton.setEnabled(true);\n            binding.loginButton.setEnabled(true);\n            //highlight-next-line\n            binding.googleSignInButton.setEnabled(true);\n            binding.emailEditText.setEnabled(true);\n            binding.passwordEditText.setEnabled(true);\n            binding.progressBar.setVisibility(View.GONE);\n        }\n    }\n\n    private void inicializarBotones() {\n        binding.registerButton.setOnClickListener(v -> {\n            String email = binding.emailEditText.getText().toString();\n            String pass = binding.passwordEditText.getText().toString();\n            viewModel.register(email, pass);\n        });\n\n        binding.loginButton.setOnClickListener(v -> {\n            String email = binding.emailEditText.getText().toString();\n            String pass = binding.passwordEditText.getText().toString();\n            viewModel.login(email, pass);\n        });\n\n        // Bot\xf3n espec\xedfico de login con Google\n        //highlight-start\n        binding.googleSignInButton.setOnClickListener(v -> {\n            Intent signInIntent = googleClient.getSignInIntent();\n            googleLauncher.launch(signInIntent);\n        });\n        //highlight-end\n    }\n\n    // M\xe9todo que navega a la pantalla principal\n    private void goToMain() {\n        startActivity(new Intent(this, MainActivity.class));\n        finish();\n    }\n}\n'})}),(0,o.jsxs)(n.admonition,{title:"Explicaci\xf3n del flujo de login con Google en LoginActivity",type:"info",children:[(0,o.jsxs)(n.p,{children:["A continuaci\xf3n se explica el c\xf3digo a\xf1adido para el login con Google, indicando ",(0,o.jsx)(n.strong,{children:"qu\xe9 hace cada parte"})," y ",(0,o.jsx)(n.strong,{children:"por qu\xe9 es necesaria"}),"."]}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"1. Cliente de Google y launcher del intent"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:"private GoogleSignInClient googleClient;\nprivate ActivityResultLauncher<Intent> googleLauncher;\n"})}),(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"GoogleSignInClient"})," es el objeto que permite lanzar el selector de cuentas de Google."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"ActivityResultLauncher"})," se utiliza para recibir el resultado del intent de Google de forma moderna y segura."]}),"\n"]}),(0,o.jsx)(n.hr,{}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"2. Configuraci\xf3n de Google Sign-In"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:"private void configurarGoogleSignIn() {\n    GoogleSignInOptions gso =\n            new GoogleSignInOptions.Builder(GoogleSignInOptions.DEFAULT_SIGN_IN)\n                    .requestEmail()\n                    .requestIdToken(getString(R.string.default_web_client_id))\n                    .build();\n\n    googleClient = GoogleSignIn.getClient(this, gso);\n}\n"})}),(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Se configuran las opciones del login con Google."}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"requestEmail()"})," permite acceder al correo del usuario."]}),"\n",(0,o.jsxs)(n.li,{children:[(0,o.jsx)(n.code,{children:"requestIdToken(...)"})," es imprescindible para Firebase:","\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsxs)(n.li,{children:["Solicita a Google un ",(0,o.jsx)(n.code,{children:"idToken"}),"."]}),"\n",(0,o.jsx)(n.li,{children:"Este token es la prueba de que el usuario ha sido autenticado por Google."}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["Con estas opciones se crea el ",(0,o.jsx)(n.code,{children:"GoogleSignInClient"}),", que se usar\xe1 para lanzar el login."]}),"\n"]}),(0,o.jsx)(n.hr,{}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"3. Inicializaci\xf3n del launcher de Google"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:'private void inicializarLauncherGoogleSignIn() {\n    googleLauncher = registerForActivityResult(\n            new ActivityResultContracts.StartActivityForResult(),\n            result -> {\n                if (result.getResultCode() != Activity.RESULT_OK || result.getData() == null) {\n                    Toast.makeText(this, "Login con Google cancelado.", Toast.LENGTH_SHORT).show();\n                    return;\n                }\n\n                Task<GoogleSignInAccount> task =\n                        GoogleSignIn.getSignedInAccountFromIntent(result.getData());\n\n                gestionarResultadoSignIn(task);\n            }\n    );\n}\n'})}),(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Se registra el launcher que recibir\xe1 el resultado del selector de Google."}),"\n",(0,o.jsx)(n.li,{children:"Si el usuario cancela el proceso, se muestra un mensaje y no se contin\xfaa."}),"\n",(0,o.jsxs)(n.li,{children:["Si hay datos, se obtiene un ",(0,o.jsx)(n.code,{children:"Task<GoogleSignInAccount>"})," que contiene la informaci\xf3n de la cuenta seleccionada."]}),"\n",(0,o.jsx)(n.li,{children:"La l\xf3gica se delega a un m\xe9todo espec\xedfico para mantener el c\xf3digo m\xe1s claro."}),"\n"]}),(0,o.jsx)(n.hr,{}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"4. Gesti\xf3n del resultado del login con Google"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:'private void gestionarResultadoSignIn(Task<GoogleSignInAccount> task) {\n    try {\n        GoogleSignInAccount account = task.getResult(ApiException.class);\n\n        if (account == null || account.getIdToken() == null) {\n            Toast.makeText(this, "No se pudo obtener la cuenta de Google.", Toast.LENGTH_LONG).show();\n            return;\n        }\n\n        viewModel.loginWithGoogle(account.getIdToken());\n\n    } catch (ApiException e) {\n        Toast.makeText(this, "Error Google Sign-In: " + e.getMessage(), Toast.LENGTH_LONG).show();\n    }\n}\n'})}),(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Se recupera la cuenta de Google autenticada."}),"\n",(0,o.jsxs)(n.li,{children:["Se valida que exista un ",(0,o.jsx)(n.code,{children:"idToken"}),":","\n",(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Sin token no es posible autenticar en Firebase."}),"\n"]}),"\n"]}),"\n",(0,o.jsxs)(n.li,{children:["El ",(0,o.jsx)(n.code,{children:"idToken"})," se env\xeda al ",(0,o.jsx)(n.code,{children:"ViewModel"}),", que se encargar\xe1 de iniciar el login en Firebase."]}),"\n",(0,o.jsx)(n.li,{children:"Cualquier error se captura y se informa al usuario."}),"\n"]}),(0,o.jsx)(n.hr,{}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"5. Lanzar el login con Google desde el bot\xf3n"})}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",children:"binding.googleSignInButton.setOnClickListener(v -> {\n    Intent signInIntent = googleClient.getSignInIntent();\n    googleLauncher.launch(signInIntent);\n});\n"})}),(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Al pulsar el bot\xf3n, se obtiene el intent de Google."}),"\n",(0,o.jsxs)(n.li,{children:["Se lanza mediante el ",(0,o.jsx)(n.code,{children:"ActivityResultLauncher"}),"."]}),"\n",(0,o.jsx)(n.li,{children:"A partir de aqu\xed, el flujo contin\xfaa en el launcher y en los m\xe9todos anteriores."}),"\n"]}),(0,o.jsx)(n.hr,{}),(0,o.jsx)(n.p,{children:(0,o.jsx)(n.strong,{children:"Idea clave"})}),(0,o.jsxs)(n.p,{children:["La ",(0,o.jsx)(n.code,{children:"LoginActivity"})," ",(0,o.jsx)(n.strong,{children:"no autentica directamente en Firebase"})," cuando se usa Google.\nSu responsabilidad es:"]}),(0,o.jsxs)(n.ul,{children:["\n",(0,o.jsx)(n.li,{children:"Lanzar el selector de cuentas de Google."}),"\n",(0,o.jsxs)(n.li,{children:["Obtener el ",(0,o.jsx)(n.code,{children:"idToken"}),"."]}),"\n",(0,o.jsxs)(n.li,{children:["Delegar la autenticaci\xf3n real en el ",(0,o.jsx)(n.code,{children:"ViewModel"}),"."]}),"\n"]}),(0,o.jsx)(n.p,{children:"De esta forma se mantiene una separaci\xf3n clara de responsabilidades y se respeta la arquitectura MVVM."})]}),(0,o.jsx)(n.hr,{}),(0,o.jsxs)(n.h2,{id:"paso-6-gestionar-el-cierre-de-sesi\xf3n-en-mainactivityjava",children:["Paso 6. Gestionar el cierre de sesi\xf3n en ",(0,o.jsx)(n.code,{children:"MainActivity.java"})]}),(0,o.jsxs)(n.p,{children:["En el demo de email y contrase\xf1a, el cierre de sesi\xf3n consist\xeda \xfanicamente en llamar a ",(0,o.jsx)(n.code,{children:"viewModel.logout()"})," (que ejecuta ",(0,o.jsx)(n.code,{children:"FirebaseAuth.signOut()"}),").\nAl a\xf1adir login con Google, incorporamos dos cambios: inicializar ",(0,o.jsx)(n.code,{children:"GoogleSignInClient"})," en la ",(0,o.jsx)(n.code,{children:"MainActivity"})," y, en el logout, cerrar tambi\xe9n la sesi\xf3n de Google ",(0,o.jsx)(n.strong,{children:"solo si"})," el usuario se autentic\xf3 con ese proveedor. Esto permite que, al volver al login, el usuario pueda seleccionar otra cuenta de Google."]}),(0,o.jsx)(n.pre,{children:(0,o.jsx)(n.code,{className:"language-java",metastring:'title="MainActivity.java"',children:'public class MainActivity extends AppCompatActivity {\n\n    private AuthViewModel viewModel;\n\n    private ActivityMainBinding binding;\n\n    private FirebaseUser user;\n\n    //highlight-next-line\n    private GoogleSignInClient googleClient;\n\n    @Override\n    protected void onCreate(Bundle savedInstanceState) {\n        super.onCreate(savedInstanceState);\n        setContentView((binding = ActivityMainBinding.inflate(getLayoutInflater())).getRoot());\n\n        viewModel = new ViewModelProvider(this).get(AuthViewModel.class);\n\n        user = viewModel.getCurrentUser();\n\n        // Si no hay un usuario conectado (porque ha pasado mucho tiempo desde el \xfaltimo login,\n        // se ha borrado cach\xe9 de la aplicaci\xf3n, etc.)\n        if (user == null) {\n            goToLogin();\n            return;\n        }\n\n        mostrarDatosUsuario();\n\n        inicializarBotonLogout();\n        //highlight-next-line\n        configurarGoogleSignIn();\n    }\n\n    //highlight-start\n    private void configurarGoogleSignIn() {\n        GoogleSignInOptions gso = new GoogleSignInOptions.Builder(GoogleSignInOptions.DEFAULT_SIGN_IN)\n                .requestEmail()\n                // MUY IMPORTANTE para Firebase:\n                .requestIdToken(getString(R.string.default_web_client_id))\n                .build();\n\n        googleClient = GoogleSignIn.getClient(this, gso);\n    }\n    //highlight-end\n\n    private void inicializarBotonLogout() {\n        binding.logoutButton.setOnClickListener(v -> {\n            viewModel.logout();\n\n            // Adem\xe1s, cerramos la sesi\xf3n de Google para que el usuario pueda cambiar de cuenta\n            //highlight-start\n            if (isGoogleLogin() && googleClient != null) {\n                googleClient.signOut();\n            }\n            //highlight-end\n\n            goToLogin();\n        });\n    }\n\n    private void mostrarDatosUsuario() {\n        binding.emailTextView.setText(user.getEmail());\n\n        // FirebaseUserMetadata contiene informaci\xf3n adicional del usuario\n        FirebaseUserMetadata meta = user.getMetadata();\n        if (meta != null) {\n            binding.creationDateTextView.setText(formatearFecha(meta.getCreationTimestamp()));\n            binding.lastLoginTextView.setText(formatearFecha(meta.getLastSignInTimestamp()));\n        } else {\n            binding.creationDateTextView.setText("-");\n            binding.lastLoginTextView.setText("-");\n        }\n    }\n\n    private void goToLogin() {\n        startActivity(new Intent(this, LoginActivity.class));\n        finish();\n    }\n\n    private String formatearFecha(long timestamp) {\n        // timestamp viene en ms\n        SimpleDateFormat sdf = new SimpleDateFormat("dd/MM/yyyy HH:mm", Locale.getDefault());\n        return sdf.format(new Date(timestamp));\n    }\n\n    //highlight-start\n    // Determina si el usuario ha iniciado sesi\xf3n con Google\n    private boolean isGoogleLogin() {\n        for (UserInfo profile : user.getProviderData()) {\n            if ("google.com".equals(profile.getProviderId())) {\n                return true;\n            }\n        }\n        return false;\n    }\n    //highlight-end\n}\n'})})]})}function g(e={}){const{wrapper:n}={...(0,l.R)(),...e.components};return n?(0,o.jsx)(n,{...e,children:(0,o.jsx)(d,{...e})}):d(e)}},51423:(e,n,i)=>{i.d(n,{A:()=>a});const a=i.p+"assets/images/google-signin-demo-b5bddab04185db8eec490f6194bea595.gif"},67920:(e,n,i)=>{i.d(n,{A:()=>a});const a=i.p+"assets/images/configuracion-proveedor-755f392b597903fc4fd29662e5c591e7.png"},68281:(e,n,i)=>{i.d(n,{A:()=>a});const a=i.p+"assets/images/habilitar-google-signin-83cad0bf6ddca4166a8398fc459e4ffe.png"},69276:(e,n,i)=>{i.d(n,{A:()=>a});const a=i.p+"assets/images/huella-digital-9550dcc1987b9c8e81893beea43a34bd.png"},99593:(e,n,i)=>{i.d(n,{A:()=>a});const a=i.p+"assets/images/configuracion-proyecto-4b750ef37afcbf275186fd69b2f4ad9e.png"}}]);