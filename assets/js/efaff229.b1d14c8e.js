"use strict";(self.webpackChunkpmdm=self.webpackChunkpmdm||[]).push([[7320],{28453:(e,n,o)=>{o.d(n,{R:()=>a,x:()=>s});var r=o(96540);const i={},c=r.createContext(i);function a(e){const n=r.useContext(c);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function s(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(c.Provider,{value:n},e.children)}},48370:(e,n,o)=>{o.r(n),o.d(n,{assets:()=>t,contentTitle:()=>s,default:()=>u,frontMatter:()=>a,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"pmdm_2425/ut5_persistencia/firebase/firestore/gestion-subcolecciones","title":"Gesti\xf3n de Subcolecciones","description":"En este apartado vamos a estudiar c\xf3mo trabajar con subcolecciones en Firestore. Trabajaremos con un modelo basado en un tabl\xf3n de anuncios, donde cada anuncio puede tener una subcolecci\xf3n de comentarios.","source":"@site/docs/00_pmdm_2425/ut5_persistencia/4-firebase/2-firestore/4-gestion-subcolecciones.md","sourceDirName":"00_pmdm_2425/ut5_persistencia/4-firebase/2-firestore","slug":"/pmdm_2425/ut5_persistencia/firebase/firestore/gestion-subcolecciones","permalink":"/DevTacora/docs/pmdm_2425/ut5_persistencia/firebase/firestore/gestion-subcolecciones","draft":false,"unlisted":false,"tags":[],"version":"current","sidebarPosition":4,"frontMatter":{"sidebar_position":4,"sidebar_label":"Gesti\xf3n de Subcolecciones","title":"Gesti\xf3n de Subcolecciones"},"sidebar":"pmdm_2425_Sidebar","previous":{"title":"Lectura en Tiempo Real","permalink":"/DevTacora/docs/pmdm_2425/ut5_persistencia/firebase/firestore/lectura-tiempo-real"},"next":{"title":"Demo Tabl\xf3n de Anuncios","permalink":"/DevTacora/docs/pmdm_2425/ut5_persistencia/firebase/firestore/demo-tablon-anuncios"}}');var i=o(74848),c=o(28453);const a={sidebar_position:4,sidebar_label:"Gesti\xf3n de Subcolecciones",title:"Gesti\xf3n de Subcolecciones"},s=void 0,t={},d=[{value:"Estructura en Firestore",id:"estructura-en-firestore",level:2},{value:"Modelo de datos",id:"modelo-de-datos",level:2},{value:"Crear (A\xf1adir un nuevo comentario)",id:"crear-a\xf1adir-un-nuevo-comentario",level:2},{value:"Leer (Obtener comentarios de un anuncio)",id:"leer-obtener-comentarios-de-un-anuncio",level:2},{value:"Actualizar un comentario",id:"actualizar-un-comentario",level:2},{value:"Eliminar un comentario",id:"eliminar-un-comentario",level:2}];function l(e){const n={admonition:"admonition",code:"code",h2:"h2",hr:"hr",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,c.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsxs)(n.p,{children:["En este apartado vamos a estudiar c\xf3mo trabajar con ",(0,i.jsx)(n.strong,{children:"subcolecciones"})," en ",(0,i.jsx)(n.strong,{children:"Firestore"}),". Trabajaremos con un modelo basado en un ",(0,i.jsx)(n.strong,{children:"tabl\xf3n de anuncios"}),", donde cada anuncio puede tener una ",(0,i.jsx)(n.strong,{children:"subcolecci\xf3n de comentarios"}),"."]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"estructura-en-firestore",children:"Estructura en Firestore"}),"\n",(0,i.jsxs)(n.p,{children:["En Firestore, podemos almacenar ",(0,i.jsx)(n.strong,{children:"subcolecciones"})," dentro de documentos para organizar los datos de forma m\xe1s estructurada."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-plaintext",children:'/anuncios (colecci\xf3n)\n   \u251c\u2500\u2500 anuncio_001 (documento)\n   \u2502      \u251c\u2500\u2500 contenido: "Primer anuncio"\n   \u2502      \u251c\u2500\u2500 fecha: 1707551200\n   \u2502      \u251c\u2500\u2500 emailAutor: "usuario@example.com"\n   \u2502\n   \u2502      /comentarios (subcolecci\xf3n)\n   \u2502           \u251c\u2500\u2500 comentario_001 (documento)\n   \u2502           \u2502      \u251c\u2500\u2500 id: "abc123"\n   \u2502           \u2502      \u251c\u2500\u2500 comentario: "Buen anuncio"\n   \u2502           \u2502      \u251c\u2500\u2500 emailUsuarioAutor: "comentador@example.com"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["Cada ",(0,i.jsx)(n.strong,{children:"anuncio"})," tiene una ",(0,i.jsx)(n.strong,{children:'subcolecci\xf3n de "comentarios"'}),", donde se almacenan los comentarios relacionados con el anuncio."]}),"\n",(0,i.jsx)(n.admonition,{title:"IMPORTANTE",type:"info",children:(0,i.jsxs)(n.p,{children:["Por este motivo, ",(0,i.jsx)(n.strong,{children:"todas las operaciones"})," sobre la ",(0,i.jsx)(n.strong,{children:"subcolecci\xf3n"})," de comentarios deben partir de la referencia al documento del ",(0,i.jsx)(n.strong,{children:"anuncio"})," correspondiente. En otras palabras, antes de acceder a la subcolecci\xf3n ",(0,i.jsx)(n.code,{children:'"comentarios"'}),", primero debes obtener el ",(0,i.jsx)(n.strong,{children:"documento del anuncio"})," con ",(0,i.jsx)(n.code,{children:'db.collection("anuncios").document(anuncioId)'}),"."]})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"modelo-de-datos",children:"Modelo de datos"}),"\n",(0,i.jsxs)(n.p,{children:["Creamos la clase ",(0,i.jsx)(n.code,{children:"Comentario"})," para representar los documentos dentro de la subcolecci\xf3n ",(0,i.jsx)(n.code,{children:"comentarios/"}),"."]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"public class Comentario {\n    private String id;\n    private String comentario;\n    private String emailUsuarioAutor;\n\n    // Constructor vac\xedo requerido por Firestore\n    public Comentario() {}\n\n    public Comentario(String id, String comentario, String emailUsuarioAutor) {\n        this.id = id;\n        this.comentario = comentario;\n        this.emailUsuarioAutor = emailUsuarioAutor;\n    }\n\n    // Getters y setters\n}\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"crear-a\xf1adir-un-nuevo-comentario",children:"Crear (A\xf1adir un nuevo comentario)"}),"\n",(0,i.jsxs)(n.p,{children:["Para a\xf1adir un comentario dentro de la ",(0,i.jsx)(n.strong,{children:'subcolecci\xf3n "comentarios"'})," de un anuncio, usamos ",(0,i.jsx)(n.code,{children:'document(anuncioId).collection("comentarios")'}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'public void addComentario(String anuncioId, Comentario comentario) {\n    FirebaseFirestore db = FirebaseFirestore.getInstance();\n\n    // Generar un ID para el comentario\n    String idGenerado = db.collection("anuncios").document(anuncioId)\n                          .collection("comentarios").document().getId();\n    \n    // Asignar el ID generado al comentario\n    comentario = new Comentario(idGenerado, comentario.getComentario(), comentario.getEmailUsuarioAutor());\n\n    // Guardar el comentario en Firestore dentro de la subcolecci\xf3n "comentarios"\n    db.collection("anuncios").document(anuncioId)\n        .collection("comentarios").document(idGenerado)\n        .set(comentario)\n        .addOnSuccessListener(aVoid -> Log.d("Firestore", "Comentario agregado con ID: " + idGenerado))\n        .addOnFailureListener(e -> Log.e("Firestore", "Error al agregar comentario", e));\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\ud83d\udd0d ",(0,i.jsx)(n.strong,{children:"Explicaci\xf3n"})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:'document(anuncioId).collection("comentarios")'})})," \u2192 Accede a la subcolecci\xf3n del anuncio."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"document().getId()"})})," \u2192 Firestore genera un ID \xfanico para el comentario."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:(0,i.jsx)(n.code,{children:"set(comentario)"})})," \u2192 Guarda el comentario dentro de la subcolecci\xf3n."]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"leer-obtener-comentarios-de-un-anuncio",children:"Leer (Obtener comentarios de un anuncio)"}),"\n",(0,i.jsx)(n.p,{children:"Podemos obtener todos los comentarios de un anuncio ordenados por ID."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'public void getComentarios(String anuncioId) {\n    FirebaseFirestore db = FirebaseFirestore.getInstance();\n\n    db.collection("anuncios").document(anuncioId)\n        .collection("comentarios")\n        .orderBy("id") // Ordena por ID ascendente\n        .get()\n        .addOnSuccessListener(queryDocumentSnapshots -> {\n            for (DocumentSnapshot document : queryDocumentSnapshots) {\n                Comentario comentario = document.toObject(Comentario.class);\n                Log.d("Firestore", "Comentario: " + comentario.getComentario());\n            }\n        })\n        .addOnFailureListener(e -> Log.e("Firestore", "Error al obtener comentarios", e));\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\ud83d\udd0d ",(0,i.jsx)(n.strong,{children:"Explicaci\xf3n"})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsxs)(n.strong,{children:["Accedemos a la subcolecci\xf3n con ",(0,i.jsx)(n.code,{children:'document(anuncioId).collection("comentarios")'})]}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsxs)(n.strong,{children:["Ordenamos los resultados con ",(0,i.jsx)(n.code,{children:'.orderBy("id")'})]}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsxs)(n.strong,{children:["Convertimos cada documento a un objeto ",(0,i.jsx)(n.code,{children:"Comentario"})," con ",(0,i.jsx)(n.code,{children:".toObject(Comentario.class)"})]}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.admonition,{title:"LECTURA EN TIEMPO REAL",type:"info",children:(0,i.jsx)(n.p,{children:"Tambi\xe9n puedes implementar la lectura en tiempo real utilizando los mismos m\xe9todos que explicamos en el documento anterior."})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"actualizar-un-comentario",children:"Actualizar un comentario"}),"\n",(0,i.jsx)(n.p,{children:"Podemos actualizar un comentario modificando su contenido sin alterar los dem\xe1s campos."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'public void updateComentario(String anuncioId, String comentarioId, String nuevoTexto) {\n    FirebaseFirestore db = FirebaseFirestore.getInstance();\n\n    db.collection("anuncios").document(anuncioId)\n        .collection("comentarios").document(comentarioId)\n        .update("comentario", nuevoTexto)\n        .addOnSuccessListener(aVoid -> Log.d("Firestore", "Comentario actualizado correctamente"))\n        .addOnFailureListener(e -> Log.e("Firestore", "Error al actualizar comentario", e));\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\ud83d\udd0d ",(0,i.jsx)(n.strong,{children:"Explicaci\xf3n"})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsxs)(n.strong,{children:['Accedemos a la subcolecci\xf3n "comentarios" dentro del anuncio con ',(0,i.jsx)(n.code,{children:'document(anuncioId).collection("comentarios").document(comentarioId)'})]}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsxs)(n.strong,{children:["Solo se actualiza el campo ",(0,i.jsx)(n.code,{children:'"comentario"'})," sin modificar los dem\xe1s datos"]}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"eliminar-un-comentario",children:"Eliminar un comentario"}),"\n",(0,i.jsx)(n.p,{children:"Podemos eliminar un comentario usando su ID."}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'public void deleteComentario(String anuncioId, String comentarioId) {\n    FirebaseFirestore db = FirebaseFirestore.getInstance();\n\n    db.collection("anuncios").document(anuncioId)\n        .collection("comentarios").document(comentarioId)\n        .delete()\n        .addOnSuccessListener(aVoid -> Log.d("Firestore", "Comentario eliminado correctamente"))\n        .addOnFailureListener(e -> Log.e("Firestore", "Error al eliminar comentario", e));\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\ud83d\udd0d ",(0,i.jsx)(n.strong,{children:"Explicaci\xf3n"})]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsxs)(n.strong,{children:["Ubicamos el comentario con ",(0,i.jsx)(n.code,{children:'document(anuncioId).collection("comentarios").document(comentarioId)'})]}),"."]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsxs)(n.strong,{children:["Llamamos a ",(0,i.jsx)(n.code,{children:".delete()"})," para eliminarlo de Firestore"]}),"."]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.admonition,{title:"TIPS PARA LA CREACI\xd3N DE SUBCOLECCIONES",type:"info",children:[(0,i.jsxs)(n.p,{children:["En ",(0,i.jsx)(n.strong,{children:"Firestore"}),", no se puede hacer una consulta que ",(0,i.jsx)(n.strong,{children:'recorra todas las subcolecciones "comentarios"'})," sin indicar el documento ",(0,i.jsx)(n.strong,{children:"padre"})," (",(0,i.jsx)(n.code,{children:"anuncioId"}),")."]}),(0,i.jsxs)(n.p,{children:["\u274c ",(0,i.jsx)(n.strong,{children:"No puedes hacer esto:"})]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'db.collection("comentarios").get(); // Error: Firestore no admite consultas directas a subcolecciones sin su documento padre.\n'})}),(0,i.jsxs)(n.p,{children:["\u2714\ufe0f ",(0,i.jsx)(n.strong,{children:"Solo puedes consultar comentarios dentro de un anuncio espec\xedfico:"})]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'db.collection("anuncios").document(anuncioId).collection("comentarios").get();\n'})}),(0,i.jsxs)(n.p,{children:["\ud83d\udccc ",(0,i.jsxs)(n.strong,{children:["Si necesitas acceder a todos los comentarios de todos los anuncios, Firestore recomienda tener una colecci\xf3n principal ",(0,i.jsx)(n.code,{children:'"comentarios"'})," donde los almacenes con un campo ",(0,i.jsx)(n.code,{children:"anuncioId"})," (documento referenciado) que indique a qu\xe9 anuncio pertenece cada comentario."]})]}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-plaintext",children:'/comentarios (colecci\xf3n principal)\n   \u251c\u2500\u2500 comentario_001 (documento)\n   \u2502      \u251c\u2500\u2500 anuncioId: "anuncio_001"\n   \u2502      \u251c\u2500\u2500 comentario: "Buen anuncio"\n   \u2502      \u251c\u2500\u2500 emailUsuarioAutor: "comentador@example.com"\n'})}),(0,i.jsx)(n.p,{children:"Esto permitir\xeda consultas como:"}),(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'db.collection("comentarios")\n    .whereEqualTo("anuncioId", anuncioId)\n    .get();\n'})})]})]})}function u(e={}){const{wrapper:n}={...(0,c.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}}}]);